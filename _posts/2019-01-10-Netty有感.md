---
layout: post
title: "Netty有感"
categories: misc
author: "yaabert" 

---

## netty有感
这两天一直在构思一个客服系统的设计.客户和客服在发出消息后肯定是不等待对方响应就返回的.服务端在接收到一端的信息后,要发送给另一端.构思上觉得还是要建立长连接.一个客服连接服务多个客户连接.这个时候需要一个能记录客服状态的容器,记录客服在线的信息,地址,服务人数,名称,将两者进行某种意义上的绑定.这里我构思采用在消息格式上实现具体的绑定.消息的格式为消息的绑定客服,消息的主题.当客户第一次请求时,消息的绑定客服处为默认值,证明该客户还没有绑定客户,服务做逻辑判定,没有则为他分配一个客户,将绑定的客服信息返回给客户端,将客户的信息转发给为其绑定的客服端.服务器发给客户端的信息格式为,消息状态,消息主体.消息状态表示有 0:服务端返回客服信息 ,1:客服返回消息,2:服务之外服务器消息.客户端根据返回的消息状态进行处理.客户端同理,发送给客户端的消息格式为,消息状态,客户信息,消息主体.客户端返回的消息格式为消息状态,消息主体.     
```
格式确定下来了,如何实现高效的分配. 
```
在服务器创建一个类,客服登录时将信息注册到这个类中去,客户请求客服资源时去访问类的资源,由于数据会变动,存在客服上线下线的情况.高并发下可能会查到错误数据.我想了下 假如是客服上线,增加资源其实是没有影响的,唯一有影响的应该是客服退出的时候资源减少,高并发下可能会查询到下线的客服资源.我想了下,为他设置一个预退出.客服在退出时,并不是直接退出,他先发起一个请求告诉服务端,我马上要下班了,不要给我分客户了,服务端收到请求后,将客服资源类中该客服资源的信息修改为预退出.然后在接下来不安排客户给他了,客服在发起预退出后,可能还会存在连接,这种业务上的事,我个人认为还是要先服务要这个客户的,所以在他处理完这个客户的时候再次发起断开请求直接断开.这个设计是我参考TCP四次挥手想到的.避免加锁引起性能变差.当然设计还是很简陋的.

```
再说下标题netty有感
```
我在做完构思后用什么做服务器是陷入深思,正好netty不是很精.于是想着用netty来做,在实践中精进技术理解.开始的时候客服资源池我是按IOC来做的比较spring用的多,后来我写netty的时候僵住了,我怎么用pom做依赖管理啊、我怎么实现数据库增删啊、我怎么做依赖注入啊、我一下子懵逼了.想了半天,然后尝试在Springboot了使用netty,当然这就是个蛇皮操作.肯定是失败了.当时觉得哪里怪怪的,但是就是不知道,一直想哪里不对劲,不知道netty是干嘛的,有什么用.后来想明白了netty本来就是服务端,怎么能把一个服务端嵌在另一个服务端里.当然是不兼容的,归根结底其实还是我springboot用的太多了,包括所有其他的服务,使用的都是spring为我提供的便捷使用方式.反而忘了最本质的使用方法.也是我没用过netty,对他的功能理解太浅显,停留在字面上,理解的不对.称这次netty的学习,反过来多springboot的认知又深刻了一些,感觉知识都是成体系的,你学会了一个点,可能会对其他的点的认知造成帮助.懂的越多,理解的越全面.果然还是要多学习.